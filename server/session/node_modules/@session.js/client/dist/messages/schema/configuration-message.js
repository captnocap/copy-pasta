/**
 *
 * THIS LEGACY PIECE OF SHIT IS DEPRECATED
 * DO NOT USE IT, USE SharedConfigMessage!!!
 *
 */
import { SignalService } from '@session.js/types/signal-bindings';
import { ContentMessage } from '../signal-message.js';
import { SessionValidationError, SessionValidationErrorCode } from '@session.js/errors';
import { hexToUint8Array } from '../../utils.js';
export class ConfigurationMessage extends ContentMessage {
    activeClosedGroups;
    activeOpenGroups;
    displayName;
    profilePicture;
    profileKey;
    contacts;
    constructor(params) {
        super({ timestamp: params.timestamp, identifier: params.identifier });
        this.activeClosedGroups = params.activeClosedGroups;
        this.activeOpenGroups = params.activeOpenGroups;
        this.displayName = params.displayName;
        this.profilePicture = params.profilePicture;
        this.profileKey = params.profileKey;
        this.contacts = params.contacts;
        if (!this.activeClosedGroups) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'closed group must be set' });
        }
        if (!this.activeOpenGroups) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'open group must be set' });
        }
        if (!this.displayName || !this.displayName?.length) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'displayName must be set' });
        }
        if (this.profilePicture && typeof this.profilePicture !== 'string') {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'profilePicture set but not an Uin8Array' });
        }
        if (this.profileKey && !(this.profileKey instanceof Uint8Array)) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'profileKey set but not an Uin8Array' });
        }
        if (!this.contacts) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'contacts must be set' });
        }
    }
    contentProto() {
        return new SignalService.Content({
            configurationMessage: this.configurationProto(),
        });
    }
    configurationProto() {
        return new SignalService.ConfigurationMessage({
            closedGroups: this.mapClosedGroupsObjectToProto(this.activeClosedGroups),
            openGroups: this.activeOpenGroups,
            displayName: this.displayName,
            profilePicture: this.profilePicture,
            profileKey: this.profileKey,
            contacts: this.mapContactsObjectToProto(this.contacts),
        });
    }
    mapClosedGroupsObjectToProto(closedGroups) {
        return (closedGroups || []).map(m => m.toProto());
    }
    mapContactsObjectToProto(contacts) {
        return (contacts || []).map(m => m.toProto());
    }
}
export class ConfigurationMessageContact {
    publicKey;
    displayName;
    profilePictureURL;
    profileKey;
    isApproved;
    isBlocked;
    didApproveMe;
    constructor({ publicKey, displayName, profilePictureURL, profileKey, isApproved, isBlocked, didApproveMe, }) {
        this.publicKey = publicKey;
        this.displayName = displayName;
        this.profilePictureURL = profilePictureURL;
        this.profileKey = profileKey;
        this.isApproved = isApproved;
        this.isBlocked = isBlocked;
        this.didApproveMe = didApproveMe;
        if (this.displayName?.length === 0) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'displayName must be set or undefined' });
        }
        if (this.profilePictureURL !== undefined && this.profilePictureURL?.length === 0) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'profilePictureURL must either undefined or not empty' });
        }
        if (this.profileKey !== undefined && this.profileKey?.length === 0) {
            throw new SessionValidationError({ code: SessionValidationErrorCode.InvalidOptions, message: 'profileKey must either undefined or not empty' });
        }
    }
    toProto() {
        return new SignalService.ConfigurationMessage.Contact({
            publicKey: this.publicKey,
            name: this.displayName,
            profilePicture: this.profilePictureURL,
            profileKey: this.profileKey,
            isApproved: this.isApproved,
            isBlocked: this.isBlocked,
            didApproveMe: this.didApproveMe,
        });
    }
}
export class ConfigurationMessageClosedGroup {
    publicKey;
    name;
    encryptionKeyPair;
    members;
    admins;
    constructor({ publicKey, name, encryptionKeyPair, members, admins, }) {
        this.publicKey = publicKey;
        this.name = name;
        this.encryptionKeyPair = encryptionKeyPair;
        this.members = members;
        this.admins = admins;
        if (!encryptionKeyPair?.privateKeyData?.byteLength ||
            !encryptionKeyPair?.publicKeyData?.byteLength) {
            throw new Error('Encryption key pair looks invalid');
        }
        if (!this.name?.length) {
            throw new Error('name must be set');
        }
        if (!this.members?.length) {
            throw new Error('members must be set');
        }
        if (!this.admins?.length) {
            throw new Error('admins must be set');
        }
        if (this.admins.some(a => !this.members.includes(a))) {
            throw new Error('some admins are not members');
        }
    }
    toProto() {
        return new SignalService.ConfigurationMessage.ClosedGroup({
            publicKey: this.publicKey,
            name: this.name,
            encryptionKeyPair: {
                publicKey: this.encryptionKeyPair.publicKeyData,
                privateKey: this.encryptionKeyPair.privateKeyData,
            },
            members: this.members.map(hexToUint8Array),
            admins: this.admins.map(hexToUint8Array),
        });
    }
}
